!function(n,t){if("function"==typeof define&&define.amd)define("bobtail-rx",["exports","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("underscore"));else{var e={exports:{}};t(e.exports,n._),n.rx=e.exports}}(this,function(n,t){"use strict";function e(n,t){if(!n)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?n:t}function r(n,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t)}function i(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")}function u(n){if(Array.isArray(n)){for(var t=0,e=Array(n.length);t<n.length;t++)e[t]=n[t];return e}return Array.from(n)}function a(n){var t=n.keys().next().value;return[t,b(n,t)]}function o(){for(var n=arguments.length,t=Array(n),e=0;e<n;e++)t[e]=arguments[e];if(t.length){var r=s.default.chain(t).map(function(n){return Array.from(n.onSet.downstreamCells)}).flatten().uniq().sortBy(function(n){return!n.internal}).value();return s.default.flatten([r,o.apply(void 0,u(r))])}return[]}function l(){for(var n=new Set,t=[],e=void 0,r=arguments.length,i=Array(r),a=0;a<r;a++)i[a]=arguments[a];var l=!0,s=!1,f=void 0;try{for(var c,h=i[Symbol.iterator]();!(l=(c=h.next()).done);l=!0){var v=c.value;n.has(v)||((e=o(v)).forEach(function(t){return n.add(t)}),t=t.concat([v].concat(u(e))))}}catch(n){s=!0,f=n}finally{try{!l&&h.return&&h.return()}finally{if(s)throw f}}return Array.from(new Set(t.reverse())).reverse()}Object.defineProperty(n,"__esModule",{value:!0}),n.transaction=n.smartUidify=n.uidify=n.basicDiff=n.cellToSet=n.cellToMap=n.cellToArray=n.flatten=n.cast=n.set=n.map=n.array=n.cell=n.autoReactify=n.reactify=n.unlift=n.lift=n.liftSpec=n.DepSet=n.SrcSet=n.ObsSet=n.DepMap=n.SrcMap=n.ObsMap=n.concat=n.IndexedArray=n.DepArray=n.IndexedDepArray=n.MappedDepArray=n.SrcArray=n.ObsArray=n.DepCell=n.SrcCell=n.ObsCell=n.ObsBase=n.subOnce=n.autoSub=n.onDispose=n.snap=n.postLagBind=n.lagBind=n.bind=n.promiseBind=n.asyncBind=n.hideMutationWarnings=n._recorder=n.types=n.upstream=n.skipFirst=n.Ev=n._depMgr=n.DepMgr=void 0,n.allDownstream=l;var s=function(n){return n&&n.__esModule?n:{default:n}}(t),f=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),c=function(){function n(n,t){var e=[],r=!0,i=!1,u=void 0;try{for(var a,o=n[Symbol.iterator]();!(r=(a=o.next()).done)&&(e.push(a.value),!t||e.length!==t);r=!0);}catch(n){i=!0,u=n}finally{try{!r&&o.return&&o.return()}finally{if(i)throw u}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return n(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=0,v=function(){return h+=1},y=function(n,t){return new Set([].concat(u(Array.from(n)),u(Array.from(t))))},d=function(n,t){return new Set(Array.from(n).filter(function(n){return t.has(n)}))},p=function(n,t){return new Set(Array.from(n).filter(function(n){return!t.has(n)}))},g=function(n,t){if(!(t in n))throw new Error("object has no key "+t);var e=n[t];return delete n[t],e},b=function(n,t){var e=n.get(t);return n.delete(t),e},m=function(n){var t=void 0,e=void 0;null==n&&(n=[]);var r=null!=Object.create?Object.create(null):{};if(s.default.isArray(n)){var i=!0,u=!1,a=void 0;try{for(var o,l=n[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var f=c(o.value,2);t=f[0],e=f[1],r[t]=e}}catch(n){u=!0,a=n}finally{try{!i&&l.return&&l.return()}finally{if(u)throw a}}}else for(t in n)e=n[t],r[t]=e;return r},_=function(n){var t=0,e=!0,r=!1,i=void 0;try{for(var u,a=n[Symbol.iterator]();!(e=(u=a.next()).done);e=!0)t+=u.value}catch(n){r=!0,i=n}finally{try{!e&&a.return&&a.return()}finally{if(r)throw i}}return t},w=n.DepMgr=function(){function n(){i(this,n),this.buffering=0,this.events=new Map}return f(n,[{key:"transaction",value:function(n){var t=this,e=void 0;this.buffering+=1;try{e=n()}finally{this.buffering-=1,0===this.buffering&&this.events.size&&function(){var n=new Set,e=new Set,r=new Set,i=new Set,o=void 0;for(t.buffering++;t.events.size;){for(var s=function(){var i=a(t.events),o=c(i,2),l=o[0],s=o[1];l.downstreamCells.forEach(function(t){n.has(t)||(t._shield=!0,t.internal&&!r.has(t)?(r.add(t),t.refresh()):e.add(t))}),l.digest?l._realPub.apply(l,u(l.digest(s))):s.forEach(function(n){return l._realPub(n)})};t.events.size;)s();(o=l.apply(void 0,u(Array.from(e)))).forEach(function(n){n._shield=!0}),o.forEach(function(n){n.refresh(),i.add(n)}),n=e,e=new Set}i.forEach(function(n){n._shield=!1}),t.buffering--}()}return e}}]),n}(),k=n._depMgr=new w,S=n.Ev=function(){function n(t,e,r){i(this,n),this.observable=e,this.init=t,this.subs=m(),this.downstreamEvents=new Set,this.digest=r}return f(n,[{key:"sub",value:function(n){var t=v();return null!=this.init&&n(this.init()),this.subs[t]=n,t}},{key:"pub",value:function(n){k.buffering?(k.events.get(this)||k.events.set(this,[]),k.events.get(this).push(n)):this._realPub(n)}},{key:"_realPub",value:function(n){for(var t in this.subs)(0,this.subs[t])(n)}},{key:"unsub",value:function(n){return g(this.subs,n)}},{key:"scoped",value:function(n,t){var e=this.sub(n);try{return t()}finally{this.unsub(e)}}},{key:"downstreamCells",get:function(){var n=new Set;return this.downstreamEvents.forEach(function(t){t.observable instanceof B&&n.add(t.observable)}),n}}]),n}(),A=n.skipFirst=function(n){var t=!0;return function(){if(t)return t=!1;for(var e=arguments.length,r=Array(e),i=0;i<e;i++)r[i]=arguments[i];return n.apply(void 0,u(r||[]))}},O=(n.upstream=function(n){var t=Array.from(n.upstreamEvents).map(function(n){return n.observable});return Array.from(new Set(t))},function(){function n(){i(this,n),this.stack=[],this.isMutating=!1,this.isIgnoring=!1,this.hidingMutationWarnings=!1,this.onMutationWarning=new S}return f(n,[{key:"record",value:function(n,t){this.stack.length>0&&!this.isMutating&&(0,s.default)(this.stack).last().addNestedBind(n),this.stack.push(n);var e=this.isMutating;this.isMutating=!1;var r=this.isIgnoring;this.isIgnoring=!1;try{return t()}finally{this.isIgnoring=r,this.isMutating=e,this.stack.pop()}}},{key:"sub",value:function(n,t){if(null==t&&(t=function(){return!0}),this.stack.length>0&&!this.isIgnoring){var e=(0,s.default)(this.stack).last();return e.upstreamEvents.add(n),n.downstreamEvents.add(e.onSet),D(n,function(){for(var n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];if(t.apply(void 0,u(r||[]))&&!e._shield)return e.refresh()})}}},{key:"addCleanup",value:function(n){if(this.stack.length>0)return(0,s.default)(this.stack).last().addCleanup(n)}},{key:"hideMutationWarnings",value:function(n){var t=this.hidingMutationWarnings;this.hidingMutationWarnings=!0;try{return n()}finally{this.hidingMutationWarnings=t}}},{key:"fireMutationWarning",value:function(){return console.warn("Mutation to observable detected during a bind context"),this.onMutationWarning.pub(null)}},{key:"mutating",value:function(n){this.stack.length>0&&!this.hidingMutationWarnings&&this.fireMutationWarning();var t=this.isMutating;this.isMutating=!0;try{return n()}finally{this.isMutating=t}}},{key:"ignoring",value:function(n){var t=this.isIgnoring;this.isIgnoring=!0;try{return n()}finally{this.isIgnoring=t}}}]),n}()),C=n.types={cell:"cell",array:"array",map:"map",set:"set"},M=n._recorder=new O,x=(n.hideMutationWarnings=function(n){return M.hideMutationWarnings(n)},n.asyncBind=function(n,t){var e=new R(t,n);return e.refresh(),e}),E=(n.promiseBind=function(n,t){return x(n,function(){var n=this;return this.record(t).done(function(t){return n.done(t)})})},n.bind=function(n){return x(null,function(){return this.done(this.record(n))})}),j=(n.lagBind=function(n,t,e){var r=null;return x(t,function(){var t=this;return null!=r&&clearTimeout(r),r=setTimeout(function(){return t.done(t.record(e))},n)})},n.postLagBind=function(n,t){var e=null;return x(n,function(){var n=this,r=this.record(t),i=r.val,u=r.ms;return null!=e&&clearTimeout(e),e=setTimeout(function(){return n.done(i)},u)})},n.snap=function(n){return M.ignoring(n)}),P=n.onDispose=function(n){return M.addCleanup(n)},D=n.autoSub=function(n,t){var e=n.sub(t);return P(function(){return n.unsub(e)}),e},z=(n.subOnce=function(n,t){var e=D(n,A(function(){t.apply(void 0,arguments),n.unsub(e)}));return e},function(){function n(){i(this,n),this.events=[],this._uid=v()}return f(n,[{key:"flatten",value:function(){return on(this)}},{key:"subAll",value:function(n){return null==n&&(n=function(){return!0}),this.events.forEach(function(t){return M.sub(t,n)})}},{key:"raw",value:function(){return this._base}},{key:"_mkEv",value:function(n,t){var e=new S(n,this,t);return this.events.push(e),e}}]),n}());z.prototype.to={cell:function(){return nn.from(void 0)},array:function(){return tn.from(void 0)},map:function(){return en.from(void 0)},set:function(){return rn.from(void 0)}},n.ObsBase=z;var B=n.ObsCell=function(n){function t(n){i(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));r._base=null!=n?n:null,r.onSet=r._mkEv(function(){return[null,r._base]},function(n){return[[s.default.first(n)[0],s.default.last(n)[1]]]}),r._shield=!1;var a=function(){return r.onSet.downstreamCells};return r.refreshAll=function(){if(r.onSet.downstreamEvents.size&&!r._shield){r._shield=!0;var n=l.apply(void 0,u(Array.from(a())||[]));n.forEach(function(n){return n._shield=!0});try{return n.forEach(function(n){return n.refresh()})}finally{n.forEach(function(n){return n._shield=!1}),r._shield=!1}}},r.refreshSub=D(r.onSet,r.refreshAll),r}return r(t,z),f(t,[{key:"all",value:function(){return this.subAll(),this._base}},{key:"get",value:function(){return this.all()}},{key:"readonly",value:function(){var n=this;return new R(function(){return n.all()})}}]),t}(),I=n.SrcCell=function(n){function t(){return i(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,B),f(t,[{key:"set",value:function(n){var t=this;return M.mutating(function(){if(t._base!==n){var e=t._base;return t._base=n,t.onSet.pub([e,n]),e}})}}]),t}(),R=n.DepCell=function(n){function t(n,r){i(this,t);var u=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,null!=r?r:null));return u.body=null!=n?n:null,u.refreshing=!1,u.nestedBinds=[],u.cleanups=[],u.upstreamEvents=new Set,u}return r(t,B),f(t,[{key:"refresh",value:function(){var n=this;!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.refreshing){var t=this._base,e=function(e){n._base=e,n.onSet.pub([t,n._base])},r=!1,i=null,u=!1,a={record:function(t){if(!n.refreshing){var o=void 0;if(n.disconnect(),r)throw new Error("this refresh has already recorded its dependencies");n.refreshing=!0,r=!0;try{o=M.record(n,function(){return t.call(a)})}finally{n.refreshing=!1}return u&&e(i),o}},done:function(r){if(t!==r){if(n.refreshing)return u=!0,i=r;e(r)}}};return this.body.call(a)}}},{key:"disconnect",value:function(){var n=this,t=!0,e=!1,r=void 0;try{for(var i,u=this.cleanups[Symbol.iterator]();!(t=(i=u.next()).done);t=!0)(0,i.value)()}catch(n){e=!0,r=n}finally{try{!t&&u.return&&u.return()}finally{if(e)throw r}}var a=!0,o=!1,l=void 0;try{for(var s,f=this.nestedBinds[Symbol.iterator]();!(a=(s=f.next()).done);a=!0)s.value.disconnect()}catch(n){o=!0,l=n}finally{try{!a&&f.return&&f.return()}finally{if(o)throw l}}return this.nestedBinds=[],this.cleanups=[],this.upstreamEvents.forEach(function(t){return t.downstreamEvents.delete(n.onSet)}),this.upstreamEvents.clear()}},{key:"addNestedBind",value:function(n){return this.nestedBinds.push(n)}},{key:"addCleanup",value:function(n){return this.cleanups.push(n)}}]),t}(),T=n.ObsArray=function(n){function t(n,r){i(this,t),null==n&&(n=[]),null==r&&(r=sn());var u=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return u._cells=n,u.diff=r,u.onChange=u._mkEv(function(){return[0,[],u._cells.map(function(n){return n.raw()})]},s.default.identity),u.onChangeCells=u._mkEv(function(){return[0,[],u._cells]},s.default.identity),u._indexed=null,u}return r(t,z),f(t,[{key:"all",value:function(){return M.sub(this.onChange),this._cells.map(function(n){return n.get()})}},{key:"raw",value:function(){return this._cells.map(function(n){return n.raw()})}},{key:"readonly",value:function(){var n=this;return new F(function(){return n.all()})}},{key:"rawCells",value:function(){return this._cells}},{key:"at",value:function(n){return M.sub(this.onChange,function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];var i=!0,u=!1,a=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=c(o.value,3),f=s[0],h=s[1],v=s[2];if(f<=n&&h.length!==v.length)return!0;if(h.length===v.length&&n<=f+h.length)return!0}}catch(n){u=!0,a=n}finally{try{!i&&l.return&&l.return()}finally{if(u)throw a}}return!1}),null!=this._cells[n]?this._cells[n].get():void 0}},{key:"length",value:function(){return M.sub(this.onChangeCells,function(){for(var n=arguments.length,t=Array(n),e=0;e<n;e++)t[e]=arguments[e];var r=0,i=!0,u=!1,a=void 0;try{for(var o,l=t[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=c(o.value,3),f=(s[0],s[1]);r+=s[2]-f}}catch(n){u=!0,a=n}finally{try{!i&&l.return&&l.return()}finally{if(u)throw a}}return!r}),this._cells.length}},{key:"size",value:function(){return this.length()}},{key:"map",value:function(n){var t=new N;return D(this.onChangeCells,function(){for(var e=arguments.length,r=Array(e),i=0;i<e;i++)r[i]=arguments[i];var u=!0,a=!1,o=void 0;try{for(var l,s=r[Symbol.iterator]();!(u=(l=s.next()).done);u=!0){var f=c(l.value,3),h=f[0],v=f[1],y=f[2],d=!0,p=!1,g=void 0;try{for(var b,m=t._cells.slice(h,h+v.length)[Symbol.iterator]();!(d=(b=m.next()).done);d=!0)b.value.disconnect()}catch(n){p=!0,g=n}finally{try{!d&&m.return&&m.return()}finally{if(p)throw g}}var _=y.map(function(t){return E(function(){return n(t.get())})});t.realSpliceCells(h,v.length,_)}}catch(n){a=!0,o=n}finally{try{!u&&s.return&&s.return()}finally{if(a)throw o}}}),t}},{key:"transform",value:function(n,t){var e=this;return new F(function(){return n(e.all())},t)}},{key:"filter",value:function(n){return this.transform(function(t){return t.filter(n)})}},{key:"slice",value:function(n,t){return this.transform(function(e){return e.slice(n,t)})}},{key:"reduce",value:function(n,t){return this.all().reduce(n,null!=t?t:this.at(0))}},{key:"reduceRight",value:function(n,t){return this.all().reduceRight(n,null!=t?t:this.at(0))}},{key:"every",value:function(n){return this.all().every(n)}},{key:"some",value:function(n){return this.all().some(n)}},{key:"indexOf",value:function(n,t){return null==t&&(t=0),this.all().indexOf(n,t)}},{key:"lastIndexOf",value:function(n,t){return null==t&&(t=this.length()-1),this.all().lastIndexOf(n,t)}},{key:"join",value:function(n){return null==n&&(n=","),this.all().join(n)}},{key:"first",value:function(){return this.at(0)}},{key:"last",value:function(){return this.at(this.length()-1)}},{key:"indexed",value:function(){var n=this;return null==this._indexed&&(this._indexed=new U,D(this.onChangeCells,function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];var i=!0,u=!1,a=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=c(o.value,3),f=s[0],h=s[1],v=s[2];n._indexed.realSpliceCells(f,h.length,v)}}catch(n){u=!0,a=n}finally{try{!i&&l.return&&l.return()}finally{if(u)throw a}}})),this._indexed}},{key:"concat",value:function(){for(var n=arguments.length,t=Array(n),e=0;e<n;e++)t[e]=arguments[e];return q.apply(void 0,[this].concat(t))}},{key:"realSpliceCells",value:function(n,t,e){var r=this,i=this._cells.splice.apply(this._cells,[n,t].concat(e)),u=j(function(){return i.map(function(n){return n.get()})}),a=j(function(){return e.map(function(n){return n.get()})});return yn(function(){return r.onChangeCells.pub([n,i,e]),r.onChange.pub([n,u,a])})}},{key:"realSplice",value:function(n,t,e){return this.realSpliceCells(n,t,e.map(nn))}},{key:"_update",value:function(n,t){var e=this,r=void 0,i=j(function(){return e._cells.map(function(n){return n.get()})}),u=[0,i.length,n];return null==t&&(t=this.diff),r=hn(i.length,n,t(i,n)),(null!=r?r:[u]).map(function(n){var t=c(n,3),r=t[0],i=t[1],u=t[2];return e.realSplice(r,i,u)})}}]),t}(),W=n.SrcArray=function(n){function t(){return i(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,T),f(t,[{key:"spliceArray",value:function(n,t,e){var r=this;return M.mutating(function(){return r.realSplice(n,t,e)})}},{key:"splice",value:function(n,t){for(var e=arguments.length,r=Array(e>2?e-2:0),i=2;i<e;i++)r[i-2]=arguments[i];return this.spliceArray(n,t,r)}},{key:"insert",value:function(n,t){return this.splice(t,0,n)}},{key:"remove",value:function(n){var t=(0,s.default)(this.raw()).indexOf(n);if(t>=0)return this.removeAt(t)}},{key:"removeAll",value:function(n){var t=this;return yn(function(){for(var e=(0,s.default)(j(function(){return t.all()})).indexOf(n);e>=0;)t.removeAt(e),e=j(function(){return(0,s.default)(t.all().slice(e))}).indexOf(n)})}},{key:"removeAt",value:function(n){var t=this,e=j(function(){return t.at(n)});return this.splice(n,1),e}},{key:"push",value:function(n){var t=this;return this.splice(j(function(){return t.length()}),0,n)}},{key:"pop",value:function(){var n=this;return this.removeAt(j(function(){return n.length()-1}))}},{key:"put",value:function(n,t){return this.splice(n,1,t)}},{key:"replace",value:function(n){var t=this;return this.spliceArray(0,j(function(){return t.length()}),n)}},{key:"unshift",value:function(n){return this.insert(n,0)}},{key:"shift",value:function(){return this.removeAt(0)}},{key:"update",value:function(n){var t=this;return M.mutating(function(){return t._update(n)})}},{key:"move",value:function(n,t){var e=this;return yn(function(){if(n!==t){var r=j(function(){return e.length()});if(n<0||n>r-1)throw"Source "+n+" is outside of bounds of array of length "+r;if(t<0||t>r)throw"Destination "+t+" is outside of bounds of array of length "+r;var i=j(function(){return e.all()[n]});n>t?(e.removeAt(n),e.insert(i,t)):(e.insert(i,t),e.removeAt(n))}})}},{key:"swap",value:function(n,t){var e=this;return yn(function(){var r=j(function(){return e.length()});if(n<0||n>r-1)throw"i1 "+n+" is outside of bounds of array of length "+r;if(t<0||t>r-1)throw"i2 "+t+" is outside of bounds of array of length "+r;var i=Math.min(n,t),u=Math.max(n,t);return e.move(i,u),e.move(u,i)})}},{key:"reverse",value:function(){var n=this;return this.update(j(function(){return n.all().reverse()})),j(function(){return n.all()})}}]),t}(),N=n.MappedDepArray=function(n){function t(){return i(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return r(t,T),t}(),U=n.IndexedDepArray=function(n){function t(n,r){i(this,t),null==n&&(n=[]);var u=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n,r));return u.is=u._cells.map(function(n,t){return nn(t)}),u.onChangeCells=u._mkEv(function(){return[0,[],s.default.zip(u._cells,u.is)]},s.default.identity),u.onChange=u._mkEv(function(){return[0,[],s.default.zip(u.is,j(function(){return u.all()}))]},s.default.identity),u}return r(t,T),f(t,[{key:"map",value:function(n){var t=new N;return D(this.onChangeCells,function(){for(var e=arguments.length,r=Array(e),i=0;i<e;i++)r[i]=arguments[i];var u=!0,a=!1,o=void 0;try{for(var l,s=r[Symbol.iterator]();!(u=(l=s.next()).done);u=!0){var f=c(l.value,3),h=f[0],v=f[1],y=f[2],d=!0,p=!1,g=void 0;try{for(var b,m=t._cells.slice(h,h+v.length)[Symbol.iterator]();!(d=(b=m.next()).done);d=!0)b.value.disconnect()}catch(n){p=!0,g=n}finally{try{!d&&m.return&&m.return()}finally{if(p)throw g}}var _=y.map(function(t){var e=c(t,2),r=e[0],i=e[1];return E(function(){return n(r.get(),i)})});t.realSpliceCells(h,v.length,_)}}catch(n){a=!0,o=n}finally{try{!u&&s.return&&s.return()}finally{if(a)throw o}}}),t}},{key:"realSpliceCells",value:function(n,t,e){for(var r,i=this,u=void 0,a=this._cells.splice.apply(this._cells,[n,t].concat(e)),o=j(function(){return a.map(function(n){return n.get()})}),l=this.is.slice(n+t),f=0;f<l.length;f++)(u=l[f]).set(n+e.length+f);var c=[],h=e.length,v=0<=h;for(u=0;v?u<h:u>h;v?u++:u--)c.push(nn(n+u));(r=this.is).splice.apply(r,[n,t].concat(c));var y=j(function(){return e.map(function(n){return n.get()})});return yn(function(){return i.onChangeCells.pub([n,a,s.default.zip(e,c)]),i.onChange.pub([n,o,s.default.zip(y,c)])})}}]),t}(),F=n.DepArray=function(n){function t(n,r){i(this,t);var u=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,[],r));return u.f=n,u.c=E(u.f),u.c.internal=!0,u.c.onSet.downstreamEvents.add(u.onChangeCells),u.c.onSet.downstreamEvents.add(u.onChange),D(u.c.onSet,function(n){var t=c(n,2),e=(t[0],t[1]);return u._update(e)}),u}return r(t,T),t}(),q=(n.IndexedArray=function(n){function t(n){i(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._cells=n,r}return r(t,F),f(t,[{key:"map",value:function(n){var t=new N;return D(this._cells.onChange,function(){for(var e=arguments.length,r=Array(e),i=0;i<e;i++)r[i]=arguments[i];var u=!0,a=!1,o=void 0;try{for(var l,s=r[Symbol.iterator]();!(u=(l=s.next()).done);u=!0){var f=c(l.value,3),h=f[0],v=f[1],y=f[2];t.realSplice(h,v.length,y.map(n))}}catch(n){a=!0,o=n}finally{try{!u&&s.return&&s.return()}finally{if(a)throw o}}}),t}}]),t}(),function(){for(var n=new N,t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];var i=e.map(function(n){return an(n,"array")}),u=e.map(function(){return 0});return i.forEach(function(t,e){return D(t.onChange,function(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];var a=!0,o=!1,l=void 0;try{for(var s,f=r[Symbol.iterator]();!(a=(s=f.next()).done);a=!0){var h=c(s.value,3),v=h[0],y=h[1],d=h[2],p=_(u.slice(0,e));u[e]+=d.length-y.length,n.realSplice(p+v,y.length,d)}}catch(n){o=!0,l=n}finally{try{!a&&f.return&&f.return()}finally{if(o)throw l}}})}),n});n.concat=q;var L=function(n){return n instanceof Map?n:s.default.isArray(n)?new Map(n):new Map(s.default.pairs(n))},J=n.ObsMap=function(n){function t(n){i(this,t),null==n&&(n=new Map);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._base=L(n),r.onAdd=r._mkEv(function(){return new Map(r._base)}),r.onRemove=r._mkEv(function(){return new Map}),r.onChange=r._mkEv(function(){return new Map}),r}return r(t,z),f(t,[{key:"get",value:function(n){return this.subAll(function(t){return t.has(n)}),this._base.get(n)}},{key:"has",value:function(n){return M.sub(this.onAdd,function(t){return t.has(n)}),M.sub(this.onRemove,function(t){return t.has(n)}),this._base.has(n)}},{key:"all",value:function(){return this.subAll(),new Map(this._base)}},{key:"readonly",value:function(){var n=this;return new H(function(){return n.all()})}},{key:"size",value:function(){return M.sub(this.onRemove),M.sub(this.onAdd),this._base.size}},{key:"realPut",value:function(n,t){if(this._base.has(n)){var e=this._base.get(n);return e!==t&&(this._base.set(n,t),this.onChange.pub(new Map([[n,[e,t]]]))),e}return this._base.set(n,t),void this.onAdd.pub(new Map([[n,t]]))}},{key:"realRemove",value:function(n){var t=b(this._base,n);return this.onRemove.pub(new Map([[n,t]])),t}},{key:"_update",value:function(n){var t=this,e=void 0,r=L(n),i=new Map(this._base),u=s.default.chain(Array.from(this._base.keys())).difference(Array.from(r.keys())).map(function(n){return[n,b(t._base,n)]}).value(),a=s.default.chain(Array.from(r.keys())).difference(Array.from(this._base.keys())).map(function(n){return e=r.get(n),t._base.set(n,e),[n,e]}).value(),o=s.default.chain(Array.from(r)).filter(function(n){var e=c(n,2),r=e[0],i=e[1];return t._base.has(r)&&t._base.get(r)!==i}).map(function(n){var e=c(n,2),r=e[0],i=e[1],u=t._base.get(r);return t._base.set(r,i),[r,[u,i]]}).value();return yn(function(){if(u.length&&t.onRemove.pub(new Map(u)),a.length&&t.onAdd.pub(new Map(a)),o.length)return t.onChange.pub(new Map(o))}),i}}]),t}(),G=n.SrcMap=function(n){function t(){return i(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,J),f(t,[{key:"put",value:function(n,t){var e=this;return M.mutating(function(){return e.realPut(n,t)})}},{key:"set",value:function(n,t){return this.put(n,t)}},{key:"delete",value:function(n){var t=this;return M.mutating(function(){var e=void 0;return t._base.has(n)&&(e=t.realRemove(n),t.onRemove.pub(new Map([[n,e]]))),e})}},{key:"remove",value:function(n){return this.delete(n)}},{key:"clear",value:function(){var n=this;return M.mutating(function(){var t=new Map(n._base);return n._base.clear(),t.size&&n.onRemove.pub(t),t})}},{key:"update",value:function(n){var t=this;return M.mutating(function(){return t._update(n)})}}]),t}(),H=n.DepMap=function(n){function t(n){i(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.f=n,r.c=E(r.f),r.c.internal=!0,r.c.onSet.downstreamEvents.add(r.onAdd),r.c.onSet.downstreamEvents.add(r.onChange),r.c.onSet.downstreamEvents.add(r.onRemove),D(r.c.onSet,function(n){var t=c(n,2),e=(t[0],t[1]);return r._update(e)}),r}return r(t,J),t}(),K=function(n){return n instanceof Set?n:new Set(n)},Q=function(n){return n instanceof Set?n:n instanceof V?n.all():(n instanceof T&&(n=n.all()),n instanceof B&&(n=n.get()),new Set(n))},V=n.ObsSet=function(n){function t(n){i(this,t),null==n&&(n=new Set);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._base=K(n),r.onChange=r._mkEv(function(){return[r._base,new Set]},function(n){var t=new Set,e=new Set,r=!0,i=!1,u=void 0;try{for(var a,o=n[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var l=c(a.value,2),s=l[0],f=l[1],h=!0,v=!1,y=void 0;try{for(var d,p=s[Symbol.iterator]();!(h=(d=p.next()).done);h=!0){var g=d.value;e.has(g)&&e.delete(g),t.add(g)}}catch(n){v=!0,y=n}finally{try{!h&&p.return&&p.return()}finally{if(v)throw y}}var b=!0,m=!1,_=void 0;try{for(var w,k=f[Symbol.iterator]();!(b=(w=k.next()).done);b=!0){var S=w.value;t.has(S)&&t.delete(S),e.add(S)}}catch(n){m=!0,_=n}finally{try{!b&&k.return&&k.return()}finally{if(m)throw _}}}}catch(n){i=!0,u=n}finally{try{!r&&o.return&&o.return()}finally{if(i)throw u}}return[[t,e]]}),r}return r(t,z),f(t,[{key:"has",value:function(n){return this.subAll(function(t){var e=c(t,2),r=e[0],i=e[1];return r.has(n)||i.has(n)}),this._base.has(n)}},{key:"all",value:function(){return this.subAll(),new Set(this._base)}},{key:"readonly",value:function(){var n=this;return new Y(function(){return n.all()})}},{key:"values",value:function(){return this.all()}},{key:"entries",value:function(){return this.all()}},{key:"size",value:function(){return this.subAll(function(n){var t=c(n,2),e=t[0],r=t[1];return e.size!==r.size}),this._base.size}},{key:"union",value:function(n){var t=this;return new Y(function(){return y(t.all(),Q(n))})}},{key:"intersection",value:function(n){var t=this;return new Y(function(){return d(t.all(),Q(n))})}},{key:"difference",value:function(n){var t=this;return new Y(function(){return p(t.all(),Q(n))})}},{key:"symmetricDifference",value:function(n){var t=this;return new Y(function(){return p(t.union(n).all(),t.intersection(n).all())})}},{key:"_update",value:function(n){var t=this;return yn(function(){var e=new Set(t._base),r=K(n),i=new Set,u=new Set;return e.forEach(function(n){if(!r.has(n))return u.add(n)}),r.forEach(function(n){if(!e.has(n))return i.add(n)}),e.forEach(function(n){return t._base.delete(n)}),r.forEach(function(n){return t._base.add(n)}),t.onChange.pub([i,u]),e})}}]),t}(),X=n.SrcSet=function(n){function t(){return i(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,V),f(t,[{key:"add",value:function(n){var t=this;return M.mutating(function(){return t._base.has(n)||(t._base.add(n),t.onChange.pub([new Set([n]),new Set])),n})}},{key:"put",value:function(n){return this.add(n)}},{key:"delete",value:function(n){var t=this;return M.mutating(function(){return t._base.has(n)&&(t._base.delete(n),t.onChange.pub([new Set,new Set([n])])),n})}},{key:"remove",value:function(n){return this.delete(n)}},{key:"clear",value:function(){var n=this;return M.mutating(function(){var t=new Set(n._base);return n._base.size&&(n._base.clear(),n.onChange.pub([new Set,t])),t})}},{key:"update",value:function(n){var t=this;return M.mutating(function(){return t._update(n)})}}]),t}(),Y=n.DepSet=function(n){function t(n){i(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.f=n,r.c=E(r.f),r.c.internal=!0,r.c.onSet.downstreamEvents.add(r.onChange),D(r.c.onSet,function(n){var t=c(n,2),e=(t[0],t[1]);return r._update(e)}),r}return r(t,V),t}(),Z=n.liftSpec=function(n){var t=[],e=void 0,r=void 0,i=!0,u=!1,a=void 0;try{for(var o,l=Object.getOwnPropertyNames(n)[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var f=o.value;null!=(e=n[f])&&[J,B,T,V].some(function(n){return e instanceof n})||(r=s.default.isFunction(e)?null:s.default.isArray(e)?"array":e instanceof Set?"set":e instanceof Map?"map":"cell",t.push([f,{type:r,val:e}]))}}catch(n){u=!0,a=n}finally{try{!i&&l.return&&l.return()}finally{if(u)throw a}}return s.default.object(t)},$=(n.lift=function(n,t){return null==t&&(t=Z(n)),s.default.mapObject(t,function(t,e){var r=t.type;return!(n[e]instanceof z)&&r in C?un[r](n[e]):n[e]})},n.unlift=function(n){return s.default.mapObject(n,function(n){return n instanceof z?n.all():n})},n.reactify=function n(t,e){var r=void 0;if(s.default.isArray(t)){var i=tn(s.default.clone(t));return Object.defineProperties(t,s.default.object(Object.getOwnPropertyNames(W.prototype).concat(Object.getOwnPropertyNames(T.prototype)).concat(Object.getOwnPropertyNames(z.prototype)).filter(function(n){return"length"!==n}).map(function(n){var e=t[n];return r={configurable:!0,enumerable:!1,value:function(){for(var r,u=void 0,a=arguments.length,o=Array(a),l=0;l<a;l++)o[l]=arguments[l];return null!=e&&(u=e.call.apply(e,[t].concat(o))),(r=i[n]).call.apply(r,[i].concat(o)),u},writable:!0},[n,r]}))),t}return Object.defineProperties(t,s.default.object(function(){var t=[];for(var i in e)r=e[i],t.push(function(t,e){var r=null;switch(e.type){case"cell":var i=nn(null!=e.val?e.val:null);r={configurable:!0,enumerable:!0,get:function(){return i.get()},set:function(n){return i.set(n)}};break;case"array":var a=n(null!=e.val?e.val:[]);r={configurable:!0,enumerable:!0,get:function(){return a.all(),a},set:function(n){return a.splice.apply(a,[0,a.length].concat(u(n))),a}};break;default:throw new Error("Unknown observable type: "+e.type)}return[t,r]}(i,r));return t}()))}),nn=(n.autoReactify=function(n){var t=[],e=!0,r=!1,i=void 0;try{for(var u,a=Object.getOwnPropertyNames(n)[Symbol.iterator]();!(e=(u=a.next()).done);e=!0){var o=u.value,l=n[o];if(!(l instanceof z)){var f=s.default.isFunction(l)?null:s.default.isArray(l)?"array":"cell";t.push([o,{type:f,val:l}])}}}catch(n){r=!0,i=n}finally{try{!e&&a.return&&a.return()}finally{if(r)throw i}}$(n,s.default.object(t))},function(n){return new I(n)});n.cell=nn,nn.from=function(n){return n instanceof B?n:E(n instanceof z?function(){return n.all()}:function(){return n})};var tn=function(n,t){return new W((null!=n?n:[]).map(nn),t)};n.array=tn,tn.from=function(n,t){var e=void 0;if(n instanceof T)return n;if(s.default.isArray(n))e=function(){return n};else{if(!(n instanceof z))throw new Error("Cannot cast "+n.constructor.name+" to array!");e=function(){return n.all()}}return new F(e,t)};var en=function(n){return new G(n)};n.map=en,en.from=function(n){return n instanceof J?n:new H(n instanceof z?function(){return n.all()}:function(){return n})};var rn=function(n){return new X(n)};n.set=rn,rn.from=function(n){return n instanceof V?n:new Y(n instanceof z?function(){return n.all()}:function(){return n})};var un={cell:nn,array:tn,map:en,set:rn},an=n.cast=function n(t,e){if(null==e&&(e="cell"),[B,T,J,V].includes(e)){var r=null;switch(e){case B:r="cell";break;case T:r="array";break;case J:r="map";break;case V:r="set"}e=r}if(s.default.isString(e))return e in C?un[e].from(t):t;var i=t,u=e;return s.default.mapObject(i,function(t,e){return u[e]?n(t,u[e]):t})},on=function(n){return new F(function(){return s.default.chain(ln([n])).flatten().filter(function(n){return null!=n}).value()})};n.flatten=on;var ln=function n(t){return t instanceof T?n(t.all()):t instanceof V?n(Array.from(t.values())):t instanceof B?n(t.get()):t instanceof Set?n(Array.from(t)):s.default.isArray(t)?t.map(function(t){return n(t)}):t},sn=(n.cellToArray=function(n,t){return new F(function(){return n.get()},t)},n.cellToMap=function(n){return new H(function(){return n.get()})},n.cellToSet=function(n){return new Y(function(){return n.get()})},n.basicDiff=function(n){return null==n&&(n=cn),function(t,e){var r=m(t.map(function(t,e){return[n(t),e]})),i=void 0;return e.map(function(t){return null!=(i=r[n(t)])?i:-1})}}),fn=n.uidify=function(n){return null!=n.__rxUid?n.__rxUid:Object.defineProperty(n,"__rxUid",{enumerable:!1,value:v()}).__rxUid},cn=n.smartUidify=function(n){return s.default.isObject(n)?fn(n):JSON.stringify(n)},hn=function(n,t,e){var r=void 0;if(!t.length)return null;var i=e.filter(function(n){return n>=0}),u=i.length-1,a=0<=u,o=[];for(r=0;a?r<u:r>u;a?r++:r--)o.push(i[r+1]-i[r]<=0);if(o.some(s.default.identity))return null;var l=[],f=-1;for(r=0;r<e.length;){for(;r<e.length&&e[r]===f+1;)f+=1,r+=1;for(var c={index:r,count:0,additions:[]};r<e.length&&-1===e[r];)c.additions.push(t[r]),r+=1;var h=r===e.length?n:e[r];c.count=h-(f+1),(c.count>0||c.additions.length>0)&&l.push([c.index,c.count,c.additions]),f=h,r+=1}return l},vn=n.transaction=function(n){return k.transaction(n)},yn=function(n){return k.buffering?n():vn(n)}});