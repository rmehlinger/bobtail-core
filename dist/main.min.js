!function(t,n){if("function"==typeof define&&define.amd)define("bobtail-rx",["exports","underscore"],n);else if("undefined"!=typeof exports)n(exports,require("underscore"));else{var e={exports:{}};n(e.exports,t._),t.rx=e.exports}}(this,function(t,n){"use strict";function e(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n}function r(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)}function u(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function i(t){if(Array.isArray(t)){for(var n=0,e=Array(t.length);n<t.length;n++)e[n]=t[n];return e}return Array.from(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.transaction=t.smartUidify=t.uidify=t._rxUid=t.basicDiff=t.cellToSet=t.cellToMap=t.cellToArray=t.flatten=t.cast=t.set=t.map=t.array=t.cell=t.autoReactify=t.reactify=t.unlift=t.lift=t.liftSpec=t.DepSet=t.SrcSet=t.ObsSet=t.DepMap=t.SrcMap=t.ObsMap=t.concat=t.IndexedArray=t.DepArray=t.IndexedDepArray=t.MappedDepArray=t.SrcArray=t.ObsArray=t.DepCell=t.ERROR=t.DISCONNECTED=t.LOADED=t.REFRESHING=t.INIT=t.SrcCell=t.ObsCell=t.ObsBase=t.subOnce=t.autoSub=t.onDispose=t.snap=t.postLagBind=t.lagBind=t.bind=t.promiseBind=t.asyncBind=t.hideMutationWarnings=t._recorder=t.types=t.allDownstream=t.upstream=t.skipFirst=t.Ev=t._depMgr=t.DepMgr=void 0;var a=function(t){return t&&t.__esModule?t:{default:t}}(n),o=function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}(),l=function(){function t(t,n){var e=[],r=!0,u=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(t){u=!0,i=t}finally{try{!r&&o.return&&o.return()}finally{if(u)throw i}}return e}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=0,f=function(){return s+=1},c=function(t,n){return new Set([].concat(i(Array.from(t)),i(Array.from(n))))},h=function(t,n){return new Set(Array.from(t).filter(function(t){return n.has(t)}))},v=function(t,n){return new Set(Array.from(t).filter(function(t){return!n.has(t)}))},y=function(t,n){if(!(n in t))throw new Error("object has no key "+n);var e=t[n];return delete t[n],e},d=function(t,n){var e=t.get(n);return t.delete(n),e},p=function(t){var n=void 0,e=void 0;null==t&&(t=[]);var r=null!=Object.create?Object.create(null):{};if(a.default.isArray(t)){var u=!0,i=!1,o=void 0;try{for(var s,f=t[Symbol.iterator]();!(u=(s=f.next()).done);u=!0){var c=l(s.value,2);n=c[0],e=c[1],r[n]=e}}catch(t){i=!0,o=t}finally{try{!u&&f.return&&f.return()}finally{if(i)throw o}}}else for(n in t)e=t[n],r[n]=e;return r},g=function(t){var n=0,e=!0,r=!1,u=void 0;try{for(var i,a=t[Symbol.iterator]();!(e=(i=a.next()).done);e=!0)n+=i.value}catch(t){r=!0,u=t}finally{try{!e&&a.return&&a.return()}finally{if(r)throw u}}return n},b=t.DepMgr=function(){function t(){u(this,t),this.buffering=0,this.buffer=[],this.events=new Set}return o(t,[{key:"transaction",value:function(t){var n=void 0;this.buffering+=1;try{n=t()}finally{if(this.buffering-=1,0===this.buffering){var e=new Set(a.default.flatten(Array.from(this.events).map(function(t){var n=t.downstreamCells;return Array.from(n)}))),r=S.apply(void 0,i(Array.from(e||[])));r.forEach(function(t){return t._shield=!0});try{var u=this.buffer;this.buffer=[],this.events.clear(),u.map(function(t){var n=l(t,2),e=n[0],r=n[1];return e.pub(r)}),r.forEach(function(t){return t.refresh()})}finally{r.forEach(function(t){return t._shield=!1})}}}return n}}]),t}(),_=t._depMgr=new b,m=t.Ev=function(){function t(n,e){u(this,t),this.observable=e,this.init=n,this.subs=p(),this.downstreamCells=new Set}return o(t,[{key:"sub",value:function(t){var n=f();return null!=this.init&&t(this.init()),this.subs[n]=t,n}},{key:"pub",value:function(t){if(_.buffering)_.buffer.push([this,t]),_.events.add(this);else for(var n in this.subs)(0,this.subs[n])(t)}},{key:"unsub",value:function(t){return y(this.subs,t)}},{key:"scoped",value:function(t,n){var e=this.sub(t);try{return n()}finally{this.unsub(e)}}},{key:"stream",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.default.identity,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,e=new U(function(){for(var n=this,e=arguments.length,r=Array(e),u=0;u<e;u++)r[u]=arguments[u];var i=this.record(function(){return t.call.apply(t,[n._cell].concat(r))});return void 0!==i?this.done(i):this.done(this._cell.raw())},n);return P(this,function(){return e._refreshArgs.apply(e,arguments)}),e}},{key:"promiseStream",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.default.identity,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,e=this.stream(t,new Promise(function(t){return t(n)}));return E(n,function(){return e.get()})}}]),t}(),k=t.skipFirst=function(t){var n=!0;return function(){if(!n){for(var e=arguments.length,r=Array(e),u=0;u<e;u++)r[u]=arguments[u];return t.apply(this,r||[])}n=!1}},w=(t.upstream=function(t){var n=Array.from(t.upstreamEvents).map(function(t){return t.observable});return Array.from(new Set(n))},function t(){for(var n=arguments.length,e=Array(n),r=0;r<n;r++)e[r]=arguments[r];if(e.length){var u=Array.from(new Set(a.default.flatten(e.map(function(t){return Array.from(t.onSet.downstreamCells)}))));return a.default.flatten([u,t.apply(void 0,i(Array.from(u||[])))])}return[]}),S=t.allDownstream=function(){for(var t=arguments.length,n=Array(t),e=0;e<t;e++)n[e]=arguments[e];return Array.from(new Set([].concat(n,i(w.apply(void 0,i(n||[])))).reverse())).reverse()},A=function(){function t(){u(this,t),this.stack=[],this.isMutating=!1,this.isIgnoring=!1,this.hidingMutationWarnings=!1,this.onMutationWarning=new m}return o(t,[{key:"record",value:function(t,n){this.stack.length>0&&!this.isMutating&&(0,a.default)(this.stack).last().addNestedBind(t),this.stack.push(t);var e=this.isMutating;this.isMutating=!1;var r=this.isIgnoring;this.isIgnoring=!1;try{return n()}finally{this.isIgnoring=r,this.isMutating=e,this.stack.pop()}}},{key:"sub",value:function(t,n){if(null==n&&(n=function(){return!0}),this.stack.length>0&&!this.isIgnoring){var e=(0,a.default)(this.stack).last();return e.upstreamEvents.add(t),t.downstreamCells.add(e),P(t,function(){for(var t=arguments.length,r=Array(t),u=0;u<t;u++)r[u]=arguments[u];if(n.apply(void 0,i(Array.from(r||[]))))return e.refresh()})}}},{key:"addCleanup",value:function(t){if(this.stack.length>0)return(0,a.default)(this.stack).last().addCleanup(t)}},{key:"hideMutationWarnings",value:function(t){var n=this.hidingMutationWarnings;this.hidingMutationWarnings=!0;try{return t()}finally{this.hidingMutationWarnings=n}}},{key:"fireMutationWarning",value:function(){return console.warn("Mutation to observable detected during a bind context"),this.onMutationWarning.pub(null)}},{key:"mutating",value:function(t){this.stack.length>0&&!this.hidingMutationWarnings&&this.fireMutationWarning();var n=this.isMutating;this.isMutating=!0;try{return t()}finally{this.isMutating=n}}},{key:"ignoring",value:function(t){var n=this.isIgnoring;this.isIgnoring=!0;try{return t()}finally{this.isIgnoring=n}}}]),t}(),O=t.types={cell:"cell",array:"array",map:"map",set:"set"},C=t._recorder=new A,M=(t.hideMutationWarnings=function(t){return C.hideMutationWarnings(t)},t.asyncBind=function(t,n){var e=new U(n,t);return e.refresh(),e}),E=t.promiseBind=function(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){return null};return M(t,function(){var t=this,r=this.record(n);return r.then(function(n){return t.done(n)}).catch(function(n){return t.done(e(n))}),r})},j=t.bind=function(t){return M(null,function(){return this.done(this.record(t))})},x=(t.lagBind=function(t,n,e){var r=null;return M(n,function(){var n=this;return null!=r&&clearTimeout(r),r=setTimeout(function(){return n.done(n.record(e))},t)})},t.postLagBind=function(t,n){var e=null;return M(t,function(){var t=this,r=this.record(n),u=r.val,i=r.ms;return null!=e&&clearTimeout(e),e=setTimeout(function(){return t.done(u)},i)})},t.snap=function(t){return C.ignoring(t)}),D=t.onDispose=function(t){return C.addCleanup(t)},P=t.autoSub=function(t,n){var e=t.sub(n);return D(function(){return t.unsub(e)}),e},R=(t.subOnce=function(t,n){var e=P(t,k(function(){n.apply(void 0,arguments),t.unsub(e)}));return e},function(){function t(){u(this,t),this.events=[],this._mkEv()}return o(t,[{key:"flatten",value:function(){return ct(this)}},{key:"subAll",value:function(t){return null==t&&(t=function(){return!0}),this.events.forEach(function(n){return C.sub(n,t)})}},{key:"raw",value:function(){return this._base}},{key:"_mkEv",value:function(t){var n=new m(t,this);return this.events.push(n),n}},{key:"toCell",value:function(){return it.from(this)}},{key:"toArray",value:function(){return at.from(this)}},{key:"toMap",value:function(){return ot.from(this)}},{key:"toSet",value:function(){return lt.from(this)}}]),t}());t.ObsBase=R;var I=t.ObsCell=function(t){function n(t){u(this,n);var r=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._base=null!=t?t:null,r.onSet=r._mkEv(function(){return[null,r._base]}),r._shield=!1,P(r.onSet,function(){return r._refreshAll()}),r}return r(n,R),o(n,[{key:"_refreshAll",value:function(){var t=this.onSet.downstreamCells;if(t.size&&!this._shield){this._shield=!0;var n=S.apply(void 0,i(Array.from(t)||[]));n.forEach(function(t){return t._shield=!0});try{return n.forEach(function(t){return t.refresh()})}finally{n.forEach(function(t){return t._shield=!1}),this._shield=!1}}}},{key:"all",value:function(){var t=this;return this.subAll(function(){return!t._shield}),this._base}},{key:"get",value:function(){return this.all()}},{key:"readonly",value:function(){var t=this;return new U(function(){return t.all()})}},{key:"_update",value:function(t){if(this._base!==t){var n=this._base;return this._base=t,this.onSet.pub([n,t]),n}return this._base}}]),n}(),T=t.SrcCell=function(t){function n(){return u(this,n),e(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return r(n,I),o(n,[{key:"update",value:function(t){var n=this;return C.mutating(function(){return n._update(t)})}},{key:"set",value:function(t){return this.update(t)}}]),n}(),B=t.INIT=Symbol("init"),N=t.REFRESHING=Symbol("refreshing"),z=t.LOADED=Symbol("loaded"),W=t.DISCONNECTED=Symbol("disconnected"),F=t.ERROR=Symbol("error"),U=t.DepCell=function(t){function n(t,r){u(this,n);var i=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,null!=r?r:null));return i.body=null!=t?t:null,i.refreshing=!1,i.nestedBinds=[],i.cleanups=[],i.upstreamEvents=new Set,i._rawStatus=B,i.onStatusChange=i._mkEv(function(){return i._rawStatus}),P(i.onStatusChange,function(t){return i._rawStatus=t}),i._statusCell=null,i}return r(n,I),o(n,[{key:"refresh",value:function(){return this._refreshArgs()}},{key:"_refreshArgs",value:function(){var t=this;if(!this.refreshing){this.onStatusChange.pub(N);var n=this._base,e=function(e){t._base=e;try{return t.onSet.pub([n,t._base])}finally{t.onStatusChange.pub(z)}},r=!1,u=null,i=!1,a={record:function(n){if(!t.refreshing){var a=void 0;if(t.disconnect(),r)throw new Error("this refresh has already recorded its dependencies");if(t.refreshing=!0,t.disconnect(),r)throw new Error("this refresh has already recorded its dependencies");r=!0;try{a=C.record(t,function(){return n()})}finally{t.refreshing=!1}return i&&e(u),a}},done:function(r){if(n!==r)return t.refreshing?(i=!0,u=r):e(r)},_cell:this},o=void 0;try{for(var l,s=arguments.length,f=Array(s),c=0;c<s;c++)f[c]=arguments[c];o=(l=this.body).call.apply(l,[a].concat(f)),this.onStatusChange.pub(z)}catch(t){throw this.onStatusChange.pub(F),t}return o}}},{key:"disconnect",value:function(){var t=this,n=!0,e=!1,r=void 0;try{for(var u,i=this.cleanups[Symbol.iterator]();!(n=(u=i.next()).done);n=!0)(0,u.value)()}catch(t){e=!0,r=t}finally{try{!n&&i.return&&i.return()}finally{if(e)throw r}}var a=!0,o=!1,l=void 0;try{for(var s,f=this.nestedBinds[Symbol.iterator]();!(a=(s=f.next()).done);a=!0)s.value.disconnect()}catch(t){o=!0,l=t}finally{try{!a&&f.return&&f.return()}finally{if(o)throw l}}this.nestedBinds=[],this.cleanups=[],this.upstreamEvents.forEach(function(n){return n.downstreamCells.delete(t)}),this.upstreamEvents.clear(),this.refreshing||this.onStatusChange.pub(W)}},{key:"addNestedBind",value:function(t){return this.nestedBinds.push(t)}},{key:"addCleanup",value:function(t){return this.cleanups.push(t)}},{key:"status",get:function(){return this._statusCell||(this._statusCell=this.onStatusChange.stream(a.default.identity)),this._statusCell}}]),n}(),L=t.ObsArray=function(t){function n(t,r){u(this,n),null==t&&(t=[]),null==r&&(r=vt());var i=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i._cells=t,i.diff=r,i.onChange=i._mkEv(function(){return[0,[],i._cells.map(function(t){return t.raw()})]}),i.onChangeCells=i._mkEv(function(){return[0,[],i._cells]}),i._indexed=null,i}return r(n,R),o(n,[{key:"all",value:function(){return C.sub(this.onChange),this._cells.map(function(t){return t.get()})}},{key:"raw",value:function(){return this._cells.map(function(t){return t.raw()})}},{key:"readonly",value:function(){var t=this;return new J(function(){return t.all()})}},{key:"rawCells",value:function(){return this._cells}},{key:"at",value:function(t){return C.sub(this.onChange,function(n){var e=l(n,3),r=e[0],u=e[1],i=e[2];return r<=t&&u.length!==i.length||u.length===i.length&&t<=r+u.length}),null!=this._cells[t]?this._cells[t].get():void 0}},{key:"length",value:function(){return C.sub(this.onChangeCells,function(t){var n=l(t,3),e=(n[0],n[1]),r=n[2];return e.length!==r.length}),this._cells.length}},{key:"size",value:function(){return this.length()}},{key:"map",value:function(t){var n=new H;return P(this.onChangeCells,function(e){var r=l(e,3),u=r[0],i=r[1],a=r[2],o=!0,s=!1,f=void 0;try{for(var c,h=n._cells.slice(u,u+i.length)[Symbol.iterator]();!(o=(c=h.next()).done);o=!0)c.value.disconnect()}catch(t){s=!0,f=t}finally{try{!o&&h.return&&h.return()}finally{if(s)throw f}}var v=a.map(function(n){return j(function(){return t(n.get())})});return n.realSpliceCells(u,i.length,v)}),n}},{key:"transform",value:function(t,n){var e=this;return new J(function(){return t(e.all())},n)}},{key:"filter",value:function(t){return this.transform(function(n){return n.filter(t)})}},{key:"slice",value:function(t,n){return this.transform(function(e){return e.slice(t,n)})}},{key:"reduce",value:function(t,n){return this.all().reduce(t,null!=n?n:this.at(0))}},{key:"reduceRight",value:function(t,n){return this.all().reduceRight(t,null!=n?n:this.at(0))}},{key:"every",value:function(t){return this.all().every(t)}},{key:"some",value:function(t){return this.all().some(t)}},{key:"indexOf",value:function(t,n){return null==n&&(n=0),this.all().indexOf(t,n)}},{key:"lastIndexOf",value:function(t,n){return null==n&&(n=this.length()-1),this.all().lastIndexOf(t,n)}},{key:"join",value:function(t){return null==t&&(t=","),this.all().join(t)}},{key:"first",value:function(){return this.at(0)}},{key:"last",value:function(){return this.at(this.length()-1)}},{key:"indexed",value:function(){var t=this;return null==this._indexed&&(this._indexed=new q,P(this.onChangeCells,function(n){var e=l(n,3),r=e[0],u=e[1],i=e[2];return t._indexed.realSpliceCells(r,u.length,i)})),this._indexed}},{key:"concat",value:function(){for(var t=arguments.length,n=Array(t),e=0;e<t;e++)n[e]=arguments[e];return K.apply(void 0,[this].concat(n))}},{key:"realSpliceCells",value:function(t,n,e){var r=this,u=this._cells.splice.apply(this._cells,[t,n].concat(e)),i=x(function(){return u.map(function(t){return t.get()})}),a=x(function(){return e.map(function(t){return t.get()})});return bt(function(){return r.onChangeCells.pub([t,u,e]),r.onChange.pub([t,i,a])})}},{key:"realSplice",value:function(t,n,e){return this.realSpliceCells(t,n,e.map(it))}},{key:"_update",value:function(t,n){var e=this,r=void 0,u=x(function(){return e._cells.map(function(t){return t.get()})}),i=[0,u.length,t];return n=n||this.diff,r=gt(u.length,t,n(u,t)),(null!=r?r:[i]).map(function(t){var n=l(t,3),r=n[0],u=n[1],i=n[2];return e.realSplice(r,u,i)})}}]),n}(),G=t.SrcArray=function(t){function n(){return u(this,n),e(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return r(n,L),o(n,[{key:"spliceArray",value:function(t,n,e){var r=this;return C.mutating(function(){return r.realSplice(t,n,e)})}},{key:"splice",value:function(t,n){for(var e=arguments.length,r=Array(e>2?e-2:0),u=2;u<e;u++)r[u-2]=arguments[u];return this.spliceArray(t,n,r)}},{key:"insert",value:function(t,n){return this.splice(n,0,t)}},{key:"remove",value:function(t){var n=(0,a.default)(this.raw()).indexOf(t);if(n>=0)return this.removeAt(n)}},{key:"removeAll",value:function(t){var n=this;return bt(function(){for(var e=(0,a.default)(x(function(){return n.all()})).indexOf(t);e>=0;)n.removeAt(e),e=x(function(){return(0,a.default)(n.all().slice(e))}).indexOf(t)})}},{key:"removeAt",value:function(t){var n=this,e=x(function(){return n.at(t)});return this.splice(t,1),e}},{key:"push",value:function(t){var n=this;return this.splice(x(function(){return n.length()}),0,t)}},{key:"pop",value:function(){var t=this;return this.removeAt(x(function(){return t.length()-1}))}},{key:"put",value:function(t,n){return this.splice(t,1,n)}},{key:"replace",value:function(t){var n=this;return this.spliceArray(0,x(function(){return n.length()}),t)}},{key:"unshift",value:function(t){return this.insert(t,0)}},{key:"shift",value:function(){return this.removeAt(0)}},{key:"update",value:function(t){var n=this;return C.mutating(function(){return n._update(t)})}},{key:"move",value:function(t,n){var e=this;return bt(function(){if(t!==n){var r=x(function(){return e.length()});if(t<0||t>r-1)throw"Source "+t+" is outside of bounds of array of length "+r;if(n<0||n>r)throw"Destination "+n+" is outside of bounds of array of length "+r;var u=x(function(){return e.all()[t]});t>n?(e.removeAt(t),e.insert(u,n)):(e.insert(u,n),e.removeAt(t))}})}},{key:"swap",value:function(t,n){var e=this;return bt(function(){var r=x(function(){return e.length()});if(t<0||t>r-1)throw"i1 "+t+" is outside of bounds of array of length "+r;if(n<0||n>r-1)throw"i2 "+n+" is outside of bounds of array of length "+r;var u=Math.min(t,n),i=Math.max(t,n);return e.move(u,i),e.move(i,u)})}},{key:"reverse",value:function(){var t=this;return this.update(x(function(){return t.all().reverse()})),x(function(){return t.all()})}}]),n}(),H=t.MappedDepArray=function(t){function n(){return u(this,n),e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this))}return r(n,L),n}(),q=t.IndexedDepArray=function(t){function n(t,r){u(this,n),null==t&&(t=[]);var i=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,r));return i.is=i._cells.map(function(t,n){return it(n)}),i.onChangeCells=i._mkEv(function(){return[0,[],a.default.zip(i._cells,i.is)]}),i.onChange=i._mkEv(function(){return[0,[],a.default.zip(i.is,x(function(){return i.all()}))]}),i}return r(n,L),o(n,[{key:"map",value:function(t){var n=new H;return P(this.onChangeCells,function(e){var r=l(e,3),u=r[0],i=r[1],a=r[2],o=!0,s=!1,f=void 0;try{for(var c,h=n._cells.slice(u,u+i.length)[Symbol.iterator]();!(o=(c=h.next()).done);o=!0)c.value.disconnect()}catch(t){s=!0,f=t}finally{try{!o&&h.return&&h.return()}finally{if(s)throw f}}var v=a.map(function(n){var e=l(n,2),r=e[0],u=e[1];return j(function(){return t(r.get(),u)})});return n.realSpliceCells(u,i.length,v)}),n}},{key:"realSpliceCells",value:function(t,n,e){for(var r,u=this,i=void 0,o=this._cells.splice.apply(this._cells,[t,n].concat(e)),l=x(function(){return o.map(function(t){return t.get()})}),s=this.is.slice(t+n),f=0;f<s.length;f++)(i=s[f]).set(t+e.length+f);var c=[],h=e.length,v=0<=h;for(i=0;v?i<h:i>h;v?i++:i--)c.push(it(t+i));(r=this.is).splice.apply(r,[t,n].concat(c));var y=x(function(){return e.map(function(t){return t.get()})});return bt(function(){return u.onChangeCells.pub([t,o,a.default.zip(e,c)]),u.onChange.pub([t,l,a.default.zip(y,c)])})}}]),n}(),J=t.DepArray=function(t){function n(t,r){u(this,n);var i=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[],r));return i.f=t,P(j(function(){return Array.from(i.f())}).onSet,function(t){var n=l(t,2),e=(n[0],n[1]);return i._update(e)}),i}return r(n,L),n}(),K=(t.IndexedArray=function(t){function n(t){u(this,n);var r=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._cells=t,r}return r(n,J),o(n,[{key:"map",value:function(t){var n=new H;return P(this._cells.onChange,function(e){var r=l(e,3),u=r[0],i=r[1],a=r[2];return n.realSplice(u,i.length,a.map(t))}),n}}]),n}(),function(){for(var t=new H,n=arguments.length,e=Array(n),r=0;r<n;r++)e[r]=arguments[r];var u=e.map(function(t){return ft(t,"array")}),i=e.map(function(){return 0});return u.forEach(function(n,e){return P(n.onChange,function(n){var r=l(n,3),u=r[0],a=r[1],o=r[2],s=g(i.slice(0,e));return i[e]+=o.length-a.length,t.realSplice(s+u,a.length,o)})}),t});t.concat=K;var Q=function(t){return t instanceof Map?t:a.default.isArray(t)||t instanceof Set?new Map(t):new Map(a.default.pairs(t))},V=t.ObsMap=function(t){function n(t){u(this,n),null==t&&(t=new Map);var r=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._base=Q(t),r.onAdd=r._mkEv(function(){return new Map(r._base)}),r.onRemove=r._mkEv(function(){return new Map}),r.onChange=r._mkEv(function(){return new Map}),r}return r(n,R),o(n,[{key:"get",value:function(t){return this.subAll(function(n){return n.has(t)}),this._base.get(t)}},{key:"has",value:function(t){return C.sub(this.onAdd,function(n){return n.has(t)}),C.sub(this.onRemove,function(n){return n.has(t)}),this._base.has(t)}},{key:"all",value:function(){return this.subAll(),new Map(this._base)}},{key:"readonly",value:function(){var t=this;return new Y(function(){return t.all()})}},{key:"size",value:function(){return C.sub(this.onRemove),C.sub(this.onAdd),this._base.size}},{key:"_realPut",value:function(t,n){if(this._base.has(t)){var e=this._base.get(t);return e!==n&&(this._base.set(t,n),this.onChange.pub(new Map([[t,[e,n]]]))),e}return this._base.set(t,n),void this.onAdd.pub(new Map([[t,n]]))}},{key:"_realRemove",value:function(t){var n=d(this._base,t);return this.onRemove.pub(new Map([[t,n]])),n}},{key:"_update",value:function(t){var n=this,e=void 0,r=Q(t),u=new Map(this._base),i=a.default.chain(Array.from(this._base.keys())).difference(Array.from(r.keys())).map(function(t){return[t,d(n._base,t)]}).value(),o=a.default.chain(Array.from(r.keys())).difference(Array.from(this._base.keys())).map(function(t){return e=r.get(t),n._base.set(t,e),[t,e]}).value(),s=a.default.chain(Array.from(r)).filter(function(t){var e=l(t,2),r=e[0],u=e[1];return n._base.has(r)&&n._base.get(r)!==u}).map(function(t){var e=l(t,2),r=e[0],u=e[1],i=n._base.get(r);return n._base.set(r,u),[r,[i,u]]}).value();return bt(function(){if(i.length&&n.onRemove.pub(new Map(i)),o.length&&n.onAdd.pub(new Map(o)),s.length)return n.onChange.pub(new Map(s))}),u}}]),n}(),X=t.SrcMap=function(t){function n(){return u(this,n),e(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return r(n,V),o(n,[{key:"put",value:function(t,n){var e=this;return C.mutating(function(){return e._realPut(t,n)})}},{key:"set",value:function(t,n){return this.put(t,n)}},{key:"delete",value:function(t){var n=this;return C.mutating(function(){var e=void 0;return n._base.has(t)&&(e=n._realRemove(t),n.onRemove.pub(new Map([[t,e]]))),e})}},{key:"remove",value:function(t){return this.delete(t)}},{key:"clear",value:function(){var t=this;return C.mutating(function(){var n=new Map(t._base);return t._base.clear(),n.size&&t.onRemove.pub(n),n})}},{key:"update",value:function(t){var n=this;return C.mutating(function(){return n._update(t)})}}]),n}(),Y=t.DepMap=function(t){function n(t){u(this,n);var r=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));r.f=t;var i=j(r.f);return P(i.onSet,function(t){var n=l(t,2),e=(n[0],n[1]);return r._update(e)}),r}return r(n,V),n}(),Z=function(t){return t instanceof Set?t:new Set(t)},$=function(t){return t instanceof R&&(t=t.all()),new Set(t)},tt=t.ObsSet=function(t){function n(t){u(this,n),null==t&&(t=new Set);var r=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._base=Z(t),r.onChange=r._mkEv(function(){return[r._base,new Set]}),r}return r(n,R),o(n,[{key:"has",value:function(t){return this.subAll(function(n){var e=l(n,2),r=e[0],u=e[1];return r.has(t)||u.has(t)}),this._base.has(t)}},{key:"all",value:function(){return this.subAll(),new Set(this._base)}},{key:"readonly",value:function(){var t=this;return new et(function(){return t.all()})}},{key:"keys",value:function(){return this.all()}},{key:"values",value:function(){return this.all()}},{key:"entries",value:function(){return this.all()}},{key:"size",value:function(){return this.subAll(function(t){var n=l(t,2),e=n[0],r=n[1];return e.size!==r.size}),this._base.size}},{key:"union",value:function(t){var n=this;return new et(function(){return c(n.all(),$(t))})}},{key:"intersection",value:function(t){var n=this;return new et(function(){return h(n.all(),$(t))})}},{key:"difference",value:function(t){var n=this;return new et(function(){return v(n.all(),$(t))})}},{key:"symmetricDifference",value:function(t){var n=this;return new et(function(){return v(n.union(t).all(),n.intersection(t).all())})}},{key:"_update",value:function(t){var n=this;return bt(function(){var e=new Set(n._base),r=Z(t),u=new Set,i=new Set;return e.forEach(function(t){if(!r.has(t))return i.add(t)}),r.forEach(function(t){if(!e.has(t))return u.add(t)}),e.forEach(function(t){return n._base.delete(t)}),r.forEach(function(t){return n._base.add(t)}),n.onChange.pub([u,i]),e})}}]),n}(),nt=t.SrcSet=function(t){function n(){return u(this,n),e(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return r(n,tt),o(n,[{key:"add",value:function(t){var n=this;return C.mutating(function(){return n._base.has(t)||(n._base.add(t),n.onChange.pub([new Set([t]),new Set])),t})}},{key:"put",value:function(t){return this.add(t)}},{key:"delete",value:function(t){var n=this;return C.mutating(function(){return n._base.has(t)&&(n._base.delete(t),n.onChange.pub([new Set,new Set([t])])),t})}},{key:"remove",value:function(t){return this.delete(t)}},{key:"clear",value:function(){var t=this;return C.mutating(function(){var n=new Set(t._base);return t._base.size&&(t._base.clear(),t.onChange.pub([new Set,n])),n})}},{key:"update",value:function(t){var n=this;return C.mutating(function(){return n._update(t)})}}]),n}(),et=t.DepSet=function(t){function n(t){u(this,n);var r=e(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));r.f=t;var i=j(r.f);return P(i.onSet,function(t){var n=l(t,2),e=(n[0],n[1]);return r._update(e)}),r}return r(n,tt),n}(),rt=t.liftSpec=function(t){var n=[],e=void 0,r=void 0,u=!0,i=!1,o=void 0;try{for(var l,s=Object.getOwnPropertyNames(t)[Symbol.iterator]();!(u=(l=s.next()).done);u=!0){var f=l.value;null!=(e=t[f])&&[V,I,L,tt].some(function(t){return e instanceof t})||(r=a.default.isFunction(e)?null:a.default.isArray(e)?"array":e instanceof Set?"set":e instanceof Map?"map":"cell",n.push([f,{type:r,val:e}]))}}catch(t){i=!0,o=t}finally{try{!u&&s.return&&s.return()}finally{if(i)throw o}}return a.default.object(n)},ut=(t.lift=function(t,n){return null==n&&(n=rt(t)),a.default.mapObject(n,function(n,e){var r=n.type;return!(t[e]instanceof R)&&r in O?st[r](t[e]):t[e]})},t.unlift=function(t){return a.default.mapObject(t,function(t){return t instanceof R?t.all():t})},t.reactify=function t(n,e){var r=void 0;if(a.default.isArray(n)){var u=at(a.default.clone(n));return Object.defineProperties(n,a.default.object(Object.getOwnPropertyNames(G.prototype).concat(Object.getOwnPropertyNames(L.prototype)).concat(Object.getOwnPropertyNames(R.prototype)).filter(function(t){return"length"!==t}).map(function(t){var e=n[t];return r={configurable:!0,enumerable:!1,value:function(){for(var r,i=void 0,a=arguments.length,o=Array(a),l=0;l<a;l++)o[l]=arguments[l];return null!=e&&(i=e.call.apply(e,[n].concat(o))),(r=u[t]).call.apply(r,[u].concat(o)),i},writable:!0},[t,r]}))),n}return Object.defineProperties(n,a.default.object(function(){var n=[];for(var u in e)r=e[u],n.push(function(n,e){var r=null;switch(e.type){case"cell":var u=it(null!=e.val?e.val:null);r={configurable:!0,enumerable:!0,get:function(){return u.get()},set:function(t){return u.set(t)}};break;case"array":var a=t(null!=e.val?e.val:[]);r={configurable:!0,enumerable:!0,get:function(){return a.all(),a},set:function(t){return a.splice.apply(a,[0,a.length].concat(i(t))),a}};break;default:throw new Error("Unknown observable type: "+e.type)}return[n,r]}(u,r));return n}()))}),it=(t.autoReactify=function(t){var n=[],e=!0,r=!1,u=void 0;try{for(var i,o=Object.getOwnPropertyNames(t)[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var l=i.value,s=t[l];if(!(s instanceof R)){var f=a.default.isFunction(s)?null:a.default.isArray(s)?"array":"cell";n.push([l,{type:f,val:s}])}}}catch(t){r=!0,u=t}finally{try{!e&&o.return&&o.return()}finally{if(r)throw u}}ut(t,a.default.object(n))},t.cell=function(t){return new T(t)});it.from=function(t){return t instanceof I?t:j(t instanceof R?function(){return t.all()}:function(){return t})};var at=t.array=function(t,n){return new G((null!=t?t:[]).map(it),n)};at.from=function(t,n){var e=void 0;if(t instanceof L)return t;if(a.default.isArray(t))e=function(){return t};else{if(!(t instanceof R))throw new Error("Cannot cast "+t.constructor.name+" to array!");e=function(){return t.all()}}return new J(e,n)};var ot=t.map=function(t){return new X(t)};ot.from=function(t){return t instanceof V?t:new Y(t instanceof R?function(){return t.all()}:function(){return t})};var lt=t.set=function(t){return new nt(t)};lt.from=function(t){return t instanceof tt?t:new et(t instanceof R?function(){return t.all()}:function(){return t})};var st={cell:it,array:at,map:ot,set:lt},ft=t.cast=function t(n,e){if(null==e&&(e="cell"),[I,L,V,tt].includes(e)){var r=null;switch(e){case I:r="cell";break;case L:r="array";break;case V:r="map";break;case tt:r="set"}e=r}if(a.default.isString(e))return e in O?st[e].from(n):n;var u=n,i=e;return a.default.mapObject(u,function(n,e){return i[e]?t(n,i[e]):n})},ct=function(t){return new J(function(){return a.default.chain(ht([t])).flatten().filter(function(t){return null!=t}).value()})};t.flatten=ct;var ht=function t(n){return n instanceof L?t(n.all()):n instanceof tt?t(Array.from(n.values())):n instanceof I?t(n.get()):n instanceof Set?t(Array.from(n)):a.default.isFunction(n)?t(j(n).get()):a.default.isArray(n)?n.map(function(n){return t(n)}):n},vt=(t.cellToArray=function(t,n){return new J(function(){return t.get()},n)},t.cellToMap=function(t){return new Y(function(){return t.get()})},t.cellToSet=function(t){return new et(function(){return t.get()})},t.basicDiff=function(t){return null==t&&(t=pt),function(n,e){var r=p(n.map(function(n,e){return[t(n),e]})),u=void 0;return e.map(function(n){return null!=(u=r[t(n)])?u:-1})}}),yt=t._rxUid=Symbol("rx uid"),dt=t.uidify=function(t){return null!=t[yt]?t[yt]:Object.defineProperty(t,yt,{enumerable:!1,value:f()})[yt]},pt=t.smartUidify=function(t){return a.default.isObject(t)?dt(t):JSON.stringify(t)},gt=function(t,n,e){var r=void 0;if(!n.length)return null;var u=e.filter(function(t){return t>=0}),i=u.length-1,o=0<=i,l=[];for(r=0;o?r<i:r>i;o?r++:r--)l.push(u[r+1]-u[r]<=0);if(l.some(a.default.identity))return null;var s=[],f=-1;for(r=0;r<e.length;){for(;r<e.length&&e[r]===f+1;)f+=1,r+=1;for(var c={index:r,count:0,additions:[]};r<e.length&&-1===e[r];)c.additions.push(n[r]),r+=1;var h=r===e.length?t:e[r];c.count=h-(f+1),(c.count>0||c.additions.length>0)&&s.push([c.index,c.count,c.additions]),f=h,r+=1}return s},bt=t.transaction=function(t){return _.transaction(t)}});